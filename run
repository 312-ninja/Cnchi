#!/bin/bash

# WARNING:
# This script is a helper that the developers use to call Cnchi (testing purposes only)
# Please, do not use if your intention is to do a "normal" installation

cleanup() {
	if [[ -h /usr/share/cnchi ]]; then
		sudo unlink /usr/share/cnchi
		sudo mv /usr/share/cnchi.tmp /usr/share/cnchi > /dev/null 2>&1
	fi
	_pid=$(cat /tmp/cnchi.pid)
	echo $_pid
	sudo kill $_pid
}

trap cleanup EXIT QUIT TERM


if [[ -d /usr/share/cnchi ]] && ! [[ -h /usr/share/cnchi ]]; then
	sudo mv /usr/share/cnchi /usr/share/cnchi.tmp > /dev/null 2>&1
fi

if [[ -d /usr/share/cnchi ]]; then
	sudo rm /usr/share/cnchi
fi

CNCHI_DIR=`pwd`
sudo ln -sf $CNCHI_DIR /usr/share/cnchi


_PYTHON="/usr/bin/python"
_PYTHON_OPTIONS="-Wall"
_XML="/usr/share/cnchi/data/packages.xml"
_CNCHI_OPTIONS="-d -v --disable-rank-mirrors -s bugsnag"

#if [ -f /usr/bin/python3 ]; then
#	_PYTHON="/usr/bin/python3"
#fi

_policy_file='com.antergos.pkexec.cnchi.policy'
[[ -f "/usr/share/polkit-1/actions/${_policy_file}" ]] || {
	sudo cp "policykit/actions/${_policy_file}" /usr/share/polkit-1/actions/ && sudo systemctl restart polkit
}

#if [[ -z "$1" ]]; then
#	sudo -E $_PYTHON $_PYTHON_OPTIONS cnchi/cnchi.py $_CNCHI_OPTIONS -p $_XML ${@} 2>&1
#else
	# Running through PyCharm Debugger
	#echo "$*"
	pkexec $_PYTHON ${@} #2>&1
#fi


